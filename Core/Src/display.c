#include "../Inc/display.h"

#include <stdio.h>

#include "../Inc/main.h"
#include "../Inc/ssd1306.h"
#include "../Inc/ssd1306_fonts.h"

static const unsigned char m2p_logo_bitmap_64[] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x07,0xff,0xff,0xff,0xff,0xf0,0x00,0x00,0x0f,0xff,0xff,0xff,0xff,0xfc,0x00,0x00,0x1f,0xff,0xff,0xff,0xff,0xfc,0x00,0x00,0x1f,0xff,0xff,0xff,0xff,0xfc,0x00,0x00,0x1f,0xff,0xff,0xff,0xff,0xfc,0x00,0x00,0x1f,0xff,0xff,0xff,0xff,0xfc,0x00,0x00,0x1f,0xe0,0x00,0x00,0x01,0xfc,0x00,0x00,0x1f,0xe0,0x00,0x00,0x01,0xfc,0x00,0x00,0x1f,0xe0,0x00,0x00,0x01,0xfc,0x00,0x00,0x1f,0xe0,0x00,0x00,0x01,0xfc,0x00,0x00,0x1f,0xe0,0x0f,0xf8,0x01,0xfc,0x00,0x00,0x1f,0xe0,0x3f,0xfe,0x01,0xfc,0x00,0x00,0x1f,0xe0,0x7f,0x8f,0x01,0xfc,0x00,0x00,0x1f,0xe0,0xff,0x83,0x81,0xfc,0x00,0x00,0x1f,0xe0,0xff,0x81,0xc1,0xfc,0x00,0x00,0x1f,0xe1,0xff,0x80,0xc1,0xfc,0x00,0x00,0x1f,0xe1,0xff,0x80,0xe1,0xfc,0x00,0x00,0x1f,0xe1,0xff,0x80,0x61,0xfc,0x00,0x00,0x1f,0xe3,0xff,0x80,0x61,0xfc,0x00,0x00,0x1f,0xe3,0xff,0x80,0x61,0xfc,0x00,0x00,0x1f,0xe3,0xff,0x00,0x61,0xfc,0x00,0x00,0x1f,0xe3,0xfc,0x00,0x61,0xfc,0x00,0x00,0x1f,0xe1,0xf0,0x00,0x61,0xfc,0x00,0x00,0x1f,0xe1,0xe0,0x00,0xe1,0xfc,0x00,0x00,0x1f,0xe1,0xc0,0x00,0xc1,0xfc,0x00,0x00,0x1f,0xe0,0xe0,0x01,0xc1,0xfc,0x00,0x00,0x1f,0xe0,0xf0,0x03,0x81,0xfc,0x00,0x00,0x1f,0xe0,0x78,0x0f,0x01,0xfc,0x00,0x00,0x1f,0xe0,0x3f,0xfe,0x01,0xfc,0x00,0x00,0x1f,0xe0,0x0f,0xf8,0x01,0xfc,0x00,0x00,0x1f,0xe0,0x00,0x00,0x01,0xfc,0x00,0x00,0x1f,0xe0,0x00,0x00,0x01,0xfc,0x00,0x00,0x1f,0xe0,0x00,0x00,0x01,0xfc,0x00,0x00,0x1f,0xe0,0x00,0x00,0x01,0xfc,0x00,0x00,0x1f,0xef,0xff,0xff,0xff,0xfc,0x00,0x00,0x1f,0xff,0xff,0xff,0xff,0xfc,0x00,0x00,0x1f,0xff,0xff,0xff,0xff,0xfc,0x00,0x00,0x1f,0xff,0xff,0xff,0xff,0xfc,0x00,0x00,0x1f,0xff,0xff,0xff,0xff,0xfc,0x00,0x00,0x1f,0xff,0xff,0xff,0xff,0xfc,0x00,0x00,0x1f,0xff,0xff,0xff,0xff,0xfc,0x00,0x00,0x1f,0xff,0xff,0xff,0xff,0xfc,0x00,0x00,0x1f,0xff,0xff,0xff,0xff,0xfc,0x00,0x00,0x1f,0xff,0xff,0xff,0xff,0xfc,0x00,0x00,0x1f,0xff,0xff,0xff,0xff,0xfc,0x00,0x00,0x1f,0xff,0xe0,0x01,0xff,0xfc,0x00,0x00,0x0f,0xff,0xc0,0x01,0xff,0xfc,0x00,0x00,0x07,0xff,0xc0,0x01,0xff,0xf8,0x00,0x00,0x00,0x01,0xc6,0x31,0xc0,0x00,0x00,0x00,0x00,0x00,0xc6,0x31,0xc0,0x00,0x00,0x00,0x00,0x00,0xc6,0x31,0xc0,0x00,0x00,0x00,0x00,0x00,0xc0,0x31,0xc0,0x00,0x00,0x00,0x00,0x00,0xc0,0x01,0xc0,0x00,0x00,0x00,0x00,0x00,0xc0,0x01,0xc0,0x00,0x00,0x00,0x00,0x00,0xc0,0x01,0xc0,0x00,0x00,0x00,0x00,0x00,0xc0,0x01,0xc0,0x00,0x00,0x00,0x00,0x00,0xc0,0x01,0xc0,0x00,0x00,0x00,0x00,0x00,0xc0,0x01,0xc0,0x00,0x00,0x00,0x00,0x00,0xc0,0x01,0xc0,0x00,0x00,0x00,0x00,0x00,0xe0,0x01,0xc0,0x00,0x00,0x00,0x00,0x00,0xff,0xff,0xc0,0x00,0x00,0x00,0x00,0x00,0xff,0xff,0xc0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00};
static const unsigned char m2p_logo_bitmap_32[] = {0x00,0x00,0x00,0x00,0x03,0xff,0xff,0xe0,0x03,0xff,0xff,0xe0,0x03,0xff,0xff,0xe0,0x03,0x80,0x01,0xe0,0x03,0x81,0xc1,0xe0,0x03,0x87,0xf1,0xe0,0x03,0x8f,0x19,0xe0,0x03,0x9f,0x09,0xe0,0x03,0x9f,0x0d,0xe0,0x03,0x9f,0x05,0xe0,0x03,0x9e,0x0d,0xe0,0x03,0x98,0x09,0xe0,0x03,0x8c,0x19,0xe0,0x03,0x87,0x71,0xe0,0x03,0x81,0xc1,0xe0,0x03,0x80,0x01,0xe0,0x03,0xc0,0x01,0xe0,0x03,0xff,0xff,0xe0,0x03,0xff,0xff,0xe0,0x03,0xff,0xff,0xe0,0x03,0xff,0xff,0xe0,0x03,0xff,0xff,0xe0,0x03,0xf8,0x1f,0xe0,0x01,0xf9,0x4f,0xc0,0x00,0x09,0x48,0x00,0x00,0x08,0x08,0x00,0x00,0x08,0x08,0x00,0x00,0x08,0x08,0x00,0x00,0x08,0x08,0x00,0x00,0x0f,0xf8,0x00,0x00,0x0f,0xf8,0x00};
static const unsigned char arrow_bitmap[] = {0x00,0x18,0x00,0x00,0x1c,0x00,0x00,0x0e,0x00,0x00,0x07,0x00,0xff,0xff,0x80,0xff,0xff,0x80,0x00,0x07,0x00,0x00,0x0e,0x00,0x00,0x1c,0x00,0x00,0x18,0x00};
static const unsigned char click_bitmap[] = {0x00,0x00,0x04,0x00,0x04,0x00,0x04,0xc0,0x00,0x80,0x70,0x00,0x03,0x80,0x02,0xe0,0x1b,0x1c,0x11,0x0e,0x01,0x3c,0x00,0xa0,0x00,0xe0,0x00,0xe0,0x00,0x40,0x00,0x00};
static const unsigned char move_bitmap[] = {0x00,0x00,0x78,0x00,0x47,0x00,0x41,0x80,0x47,0x60,0x2c,0x60,0x28,0xf0,0x38,0x60,0x12,0x64,0x0f,0xff,0x0f,0xff,0x02,0x64,0x00,0x60,0x00,0xf0,0x00,0x60,0x00,0x60};
static const unsigned char menu_selection_bitmap[] = {0x1f,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xc0,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x20,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x30,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x30,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x30,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x30,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x30,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x30,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x30,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x30,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x30,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x30,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x30,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x30,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x30,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x30,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x30,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x30,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x30,0x3f,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xe0,0x1f,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xc0};

void drawSplashScreen() {
    ssd1306_Fill(Black);

    ssd1306_DrawBitmap(30, 6, m2p_logo_bitmap_64, 64, 64, 1);

    ssd1306_SetCursor(28, SSD1306_HEIGHT - 29);
    ssd1306_WriteString("davidramiro", Font_6x8, White);

    ssd1306_SetCursor(0, SSD1306_HEIGHT - 19);
    ssd1306_WriteString("m2p-latency", Font_11x18, White);

    ssd1306_UpdateScreen();
}

void drawStartupScreen(const uint32_t min, const uint32_t max, const uint32_t cur, const uint8_t mode) {
    ssd1306_Fill(Black);

    ssd1306_DrawBitmap(3, 8, m2p_logo_bitmap_32, 32, 32, 1);

    ssd1306_SetCursor(45, 13);
    ssd1306_WriteString("davidramiro", Font_6x8, White);

    ssd1306_SetCursor(45, 24);
    ssd1306_WriteString("m2p-latency", Font_6x8, White);

    drawSensorBarInline(min, max, cur);
    drawMenuInline(mode);

    ssd1306_UpdateScreen();
}

void drawSensorBarInline(const uint32_t min, const uint32_t max, const uint32_t cur) {
    char min_buf[5];
    char max_buf[5];
    char cur_buf[5];
    snprintf(min_buf, sizeof(min_buf), "%lu", min);
    snprintf(max_buf, sizeof(max_buf), "%lu", max);
    snprintf(cur_buf, sizeof(cur_buf), "%lu", cur);
    ssd1306_SetCursor(0, SSD1306_HEIGHT - 18);
    ssd1306_WriteString(min_buf, Font_6x8, White);

    ssd1306_SetCursor(SSD1306_WIDTH / 2 - 12, SSD1306_HEIGHT - 18);
    ssd1306_WriteString(cur_buf, Font_6x8, White);

    ssd1306_SetCursor(SSD1306_WIDTH - 24, SSD1306_HEIGHT - 18);
    ssd1306_WriteString(max_buf, Font_6x8, White);

    const double bar_units = SSD1306_WIDTH / (double)(max - min);
    ssd1306_DrawRectangle(0, SSD1306_HEIGHT - 10, SSD1306_WIDTH - 1, SSD1306_HEIGHT - 1, White);
    ssd1306_FillRectangle(0, SSD1306_HEIGHT - 10, cur * bar_units, SSD1306_HEIGHT - 1, White);
}

void drawMenuInline(const uint8_t index) {
    uint8_t selectorY = 55;
    if (index == 1) {
        selectorY = 79;
    }

    ssd1306_DrawBitmap(2, selectorY, menu_selection_bitmap, 128, 21, 1);

    ssd1306_DrawBitmap(8, 57, click_bitmap, 16, 16, 1);

    ssd1306_DrawBitmap(8, 81, move_bitmap, 16, 16, 1);

    ssd1306_SetCursor(40, 61);
    ssd1306_WriteString("Click Mode", Font_6x8, White);

    ssd1306_SetCursor(43, 85);
    ssd1306_WriteString("Move Mode", Font_6x8, White);
}

void drawMeasurement(const uint32_t baseline, const uint32_t new,
    const uint32_t latency) {
    ssd1306_Fill(Black);

    ssd1306_Line(0, 36, 127, 36, 1);

    ssd1306_SetCursor(1, 1);
    ssd1306_WriteString("cycle", Font_6x8, White);

    ssd1306_SetCursor(35, 12);
    char cycle_buf[11];
    snprintf(cycle_buf, sizeof(cycle_buf), "%d / %d", cycle_index + 1, NUM_CYCLES);
    ssd1306_WriteString(cycle_buf, Font_11x18, White);

    ssd1306_Line(0, 72, 127, 72, 1);

    ssd1306_SetCursor(1, 37);

    ssd1306_WriteString("brightness", Font_6x8, White);

    ssd1306_SetCursor(3, 48);
    char baseline_buf[5];
    snprintf(baseline_buf, sizeof(baseline_buf), "%lu", baseline);
    ssd1306_WriteString(baseline_buf, Font_11x18, White);

    if (new != -1) {
        ssd1306_SetCursor(78, 48);
        char new_buf[11];
        snprintf(new_buf, sizeof(new_buf), "%lu", new);
        ssd1306_WriteString(new_buf, Font_11x18, White);

        ssd1306_DrawBitmap(55, 54, arrow_bitmap, 17, 10, 1);
    }

    ssd1306_SetCursor(1, 74);
    ssd1306_WriteString("latency", Font_6x8, White);

    if (latency != -1) {
        ssd1306_SetCursor(93, 89);
        ssd1306_WriteString("ms", Font_11x18, White);

        ssd1306_SetCursor(2, 89);
        char latency_buf[14];
        snprintf(latency_buf, sizeof(latency_buf), "%.3f", latency / 1000.0f);
        ssd1306_WriteString(latency_buf, Font_11x18, White);
    }


    ssd1306_UpdateScreen();

}

void printAverage(const float mean_ms, const float sd_ms) {
    ssd1306_Fill(Black);

    ssd1306_Line(0, 63, 128, 63, 1);

    ssd1306_SetCursor(2, 2);
    ssd1306_WriteString("average", Font_6x8, White);

    ssd1306_SetCursor(1, 67);
    ssd1306_WriteString("std dev", Font_6x8, White);

    ssd1306_SetCursor(107, 47);
    ssd1306_WriteString("ms", Font_6x8, White);

    ssd1306_SetCursor(107, 115);
    ssd1306_WriteString("ms", Font_6x8, White);

    ssd1306_SetCursor(5, 29);
    char mean_buf[14];
    snprintf(mean_buf, sizeof(mean_buf), "%.3f", mean_ms);
    ssd1306_WriteString(mean_buf, Font_11x18, White);

    ssd1306_SetCursor(5, 93);
    char sd_buf[14];
    snprintf(sd_buf, sizeof(sd_buf), "%.3f", sd_ms);
    ssd1306_WriteString(sd_buf, Font_11x18, White);

    ssd1306_UpdateScreen();
}
