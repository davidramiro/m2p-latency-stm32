#include "../Inc/display.h"

#include <stdio.h>

#include "../Inc/main.h"
#include "../Inc/ssd1306.h"
#include "../Inc/ssd1306_fonts.h"

static const unsigned char m2p_logo_bitmap_64[] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x07,0xff,0xff,0xff,0xff,0xf0,0x00,0x00,0x0f,0xff,0xff,0xff,0xff,0xfc,0x00,0x00,0x1f,0xff,0xff,0xff,0xff,0xfc,0x00,0x00,0x1f,0xff,0xff,0xff,0xff,0xfc,0x00,0x00,0x1f,0xff,0xff,0xff,0xff,0xfc,0x00,0x00,0x1f,0xff,0xff,0xff,0xff,0xfc,0x00,0x00,0x1f,0xe0,0x00,0x00,0x01,0xfc,0x00,0x00,0x1f,0xe0,0x00,0x00,0x01,0xfc,0x00,0x00,0x1f,0xe0,0x00,0x00,0x01,0xfc,0x00,0x00,0x1f,0xe0,0x00,0x00,0x01,0xfc,0x00,0x00,0x1f,0xe0,0x0f,0xf8,0x01,0xfc,0x00,0x00,0x1f,0xe0,0x3f,0xfe,0x01,0xfc,0x00,0x00,0x1f,0xe0,0x7f,0x8f,0x01,0xfc,0x00,0x00,0x1f,0xe0,0xff,0x83,0x81,0xfc,0x00,0x00,0x1f,0xe0,0xff,0x81,0xc1,0xfc,0x00,0x00,0x1f,0xe1,0xff,0x80,0xc1,0xfc,0x00,0x00,0x1f,0xe1,0xff,0x80,0xe1,0xfc,0x00,0x00,0x1f,0xe1,0xff,0x80,0x61,0xfc,0x00,0x00,0x1f,0xe3,0xff,0x80,0x61,0xfc,0x00,0x00,0x1f,0xe3,0xff,0x80,0x61,0xfc,0x00,0x00,0x1f,0xe3,0xff,0x00,0x61,0xfc,0x00,0x00,0x1f,0xe3,0xfc,0x00,0x61,0xfc,0x00,0x00,0x1f,0xe1,0xf0,0x00,0x61,0xfc,0x00,0x00,0x1f,0xe1,0xe0,0x00,0xe1,0xfc,0x00,0x00,0x1f,0xe1,0xc0,0x00,0xc1,0xfc,0x00,0x00,0x1f,0xe0,0xe0,0x01,0xc1,0xfc,0x00,0x00,0x1f,0xe0,0xf0,0x03,0x81,0xfc,0x00,0x00,0x1f,0xe0,0x78,0x0f,0x01,0xfc,0x00,0x00,0x1f,0xe0,0x3f,0xfe,0x01,0xfc,0x00,0x00,0x1f,0xe0,0x0f,0xf8,0x01,0xfc,0x00,0x00,0x1f,0xe0,0x00,0x00,0x01,0xfc,0x00,0x00,0x1f,0xe0,0x00,0x00,0x01,0xfc,0x00,0x00,0x1f,0xe0,0x00,0x00,0x01,0xfc,0x00,0x00,0x1f,0xe0,0x00,0x00,0x01,0xfc,0x00,0x00,0x1f,0xef,0xff,0xff,0xff,0xfc,0x00,0x00,0x1f,0xff,0xff,0xff,0xff,0xfc,0x00,0x00,0x1f,0xff,0xff,0xff,0xff,0xfc,0x00,0x00,0x1f,0xff,0xff,0xff,0xff,0xfc,0x00,0x00,0x1f,0xff,0xff,0xff,0xff,0xfc,0x00,0x00,0x1f,0xff,0xff,0xff,0xff,0xfc,0x00,0x00,0x1f,0xff,0xff,0xff,0xff,0xfc,0x00,0x00,0x1f,0xff,0xff,0xff,0xff,0xfc,0x00,0x00,0x1f,0xff,0xff,0xff,0xff,0xfc,0x00,0x00,0x1f,0xff,0xff,0xff,0xff,0xfc,0x00,0x00,0x1f,0xff,0xff,0xff,0xff,0xfc,0x00,0x00,0x1f,0xff,0xe0,0x01,0xff,0xfc,0x00,0x00,0x0f,0xff,0xc0,0x01,0xff,0xfc,0x00,0x00,0x07,0xff,0xc0,0x01,0xff,0xf8,0x00,0x00,0x00,0x01,0xc6,0x31,0xc0,0x00,0x00,0x00,0x00,0x00,0xc6,0x31,0xc0,0x00,0x00,0x00,0x00,0x00,0xc6,0x31,0xc0,0x00,0x00,0x00,0x00,0x00,0xc0,0x31,0xc0,0x00,0x00,0x00,0x00,0x00,0xc0,0x01,0xc0,0x00,0x00,0x00,0x00,0x00,0xc0,0x01,0xc0,0x00,0x00,0x00,0x00,0x00,0xc0,0x01,0xc0,0x00,0x00,0x00,0x00,0x00,0xc0,0x01,0xc0,0x00,0x00,0x00,0x00,0x00,0xc0,0x01,0xc0,0x00,0x00,0x00,0x00,0x00,0xc0,0x01,0xc0,0x00,0x00,0x00,0x00,0x00,0xc0,0x01,0xc0,0x00,0x00,0x00,0x00,0x00,0xe0,0x01,0xc0,0x00,0x00,0x00,0x00,0x00,0xff,0xff,0xc0,0x00,0x00,0x00,0x00,0x00,0xff,0xff,0xc0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00};
static const unsigned char m2p_logo_bitmap_32[] = {0x00,0x00,0x00,0x00,0x03,0xff,0xff,0xe0,0x03,0xff,0xff,0xe0,0x03,0xff,0xff,0xe0,0x03,0x80,0x01,0xe0,0x03,0x81,0xc1,0xe0,0x03,0x87,0xf1,0xe0,0x03,0x8f,0x19,0xe0,0x03,0x9f,0x09,0xe0,0x03,0x9f,0x0d,0xe0,0x03,0x9f,0x05,0xe0,0x03,0x9e,0x0d,0xe0,0x03,0x98,0x09,0xe0,0x03,0x8c,0x19,0xe0,0x03,0x87,0x71,0xe0,0x03,0x81,0xc1,0xe0,0x03,0x80,0x01,0xe0,0x03,0xc0,0x01,0xe0,0x03,0xff,0xff,0xe0,0x03,0xff,0xff,0xe0,0x03,0xff,0xff,0xe0,0x03,0xff,0xff,0xe0,0x03,0xff,0xff,0xe0,0x03,0xf8,0x1f,0xe0,0x01,0xf9,0x4f,0xc0,0x00,0x09,0x48,0x00,0x00,0x08,0x08,0x00,0x00,0x08,0x08,0x00,0x00,0x08,0x08,0x00,0x00,0x08,0x08,0x00,0x00,0x0f,0xf8,0x00,0x00,0x0f,0xf8,0x00};
static const unsigned char arrow_bitmap[] = {0x00,0x18,0x00,0x00,0x1c,0x00,0x00,0x0e,0x00,0x00,0x07,0x00,0xff,0xff,0x80,0xff,0xff,0x80,0x00,0x07,0x00,0x00,0x0e,0x00,0x00,0x1c,0x00,0x00,0x18,0x00};
static const unsigned char click_bitmap[] = {0x00,0x00,0x04,0x00,0x04,0x00,0x04,0xc0,0x00,0x80,0x70,0x00,0x03,0x80,0x02,0xe0,0x1b,0x1c,0x11,0x0e,0x01,0x3c,0x00,0xa0,0x00,0xe0,0x00,0xe0,0x00,0x40,0x00,0x00};
static const unsigned char move_bitmap[] = {0x00,0x00,0x78,0x00,0x47,0x00,0x41,0x80,0x47,0x60,0x2c,0x60,0x28,0xf0,0x38,0x60,0x12,0x64,0x0f,0xff,0x0f,0xff,0x02,0x64,0x00,0x60,0x00,0xf0,0x00,0x60,0x00,0x60};
static const unsigned char menu_selection_bitmap[] = {0x1f,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xc0,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x20,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x30,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x30,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x30,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x30,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x30,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x30,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x30,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x30,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x30,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x30,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x30,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x30,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x30,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x30,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x30,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x30,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x30,0x3f,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xe0,0x1f,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xc0};
static const unsigned char cogwheel_bitmap[] = {0x00,0x00,0x00,0x00,0x03,0xc0,0x03,0xc0,0x1f,0xfc,0x3f,0xfc,0x3e,0x3c,0x1c,0x1c,0x1c,0x18,0x3c,0x3c,0x3e,0x7c,0x3f,0xfc,0x1b,0xe8,0x03,0xc0,0x01,0xc0,0x00,0x00};
static const unsigned char right_bitmap[] = {0x80,0xc0,0xe0,0xf0,0xf8,0xfc,0xfe,0xff,0xfe,0xfc,0xf8,0xf0,0xe0,0xc0,0x80};
static const unsigned char left_bitmap[] = {0x01,0x03,0x07,0x0f,0x1f,0x3f,0x7f,0xff,0x7f,0x3f,0x1f,0x0f,0x07,0x03,0x01};
static const unsigned char cycles_bitmap[] = {0x07,0xe0,0x1f,0xf9,0x3f,0xff,0x7e,0x7f,0x78,0x1f,0xf0,0x7f,0xf0,0x1f,0xe0,0x03,0xe0,0x00,0xf0,0x00,0xf0,0x00,0x78,0x1c,0x7e,0x7e,0x3f,0xfc,0x1f,0xf8,0x07,0xe0};
static const unsigned char threshold_bitmap[] = {0x00,0x00,0x00,0x06,0x00,0x60,0x0e,0x00,0x70,0x1e,0x00,0x78,0x3c,0x00,0x3c,0x78,0x00,0x1e,0xff,0xff,0xff,0xff,0xff,0xff,0x78,0x00,0x1e,0x3c,0x00,0x3c,0x1e,0x00,0x78,0x0e,0x00,0x70,0x06,0x00,0x60};
static const unsigned char exit_bitmap[] = {0x02,0x00,0x06,0x00,0x0e,0x00,0x1e,0x00,0x3f,0xc0,0x7f,0xf0,0xff,0xf8,0x7f,0xf8,0x3f,0xfc,0x1e,0x3c,0x0e,0x0e,0x06,0x06,0x02,0x02,0x00,0x00};

void drawSplashScreen() {
    ssd1306_Fill(Black);

    ssd1306_DrawBitmap(30, 6, m2p_logo_bitmap_64, 64, 64, 1);

    ssd1306_SetCursor(28, SSD1306_HEIGHT - 29);
    ssd1306_WriteString("davidramiro", Font_6x8, White);

    ssd1306_SetCursor(0, SSD1306_HEIGHT - 19);
    ssd1306_WriteString("m2p-latency", Font_11x18, White);

    ssd1306_UpdateScreen();
}

void drawStartupScreen(const uint8_t mode) {
    ssd1306_Fill(Black);

    ssd1306_DrawBitmap(3, 8, m2p_logo_bitmap_32, 32, 32, 1);

    ssd1306_SetCursor(45, 13);
    ssd1306_WriteString("DAVIDRAMIRO", Font_6x8, White);

    ssd1306_SetCursor(45, 24);
    ssd1306_WriteString("M2P-LATENCY", Font_6x8, White);

    drawMainMenuInline(mode);

    ssd1306_UpdateScreen();
}

void drawSensorBarInline() {
    char min_buf[5];
    char max_buf[5];
    char cur_buf[5];
    snprintf(min_buf, sizeof(min_buf), "%lu", min_adc_val);
    snprintf(max_buf, sizeof(max_buf), "%lu", max_adc_val);
    snprintf(cur_buf, sizeof(cur_buf), "%lu", cur_adc_val);
    ssd1306_SetCursor(0, SSD1306_HEIGHT - 18);
    ssd1306_WriteString(min_buf, Font_6x8, White);

    ssd1306_SetCursor(SSD1306_WIDTH / 2 - 12, SSD1306_HEIGHT - 18);
    ssd1306_WriteString(cur_buf, Font_6x8, White);

    ssd1306_SetCursor(SSD1306_WIDTH - 24, SSD1306_HEIGHT - 18);
    ssd1306_WriteString(max_buf, Font_6x8, White);

    const double bar_units = SSD1306_WIDTH / (double)(max_adc_val - min_adc_val);
    ssd1306_DrawRectangle(0, SSD1306_HEIGHT - 10, SSD1306_WIDTH - 1, SSD1306_HEIGHT - 1, White);
    ssd1306_FillRectangle(0, SSD1306_HEIGHT - 10, cur_adc_val * bar_units, SSD1306_HEIGHT - 1, White);
}

void drawMainMenuInline(const uint8_t index) {
    const uint8_t selectorY = 55 + index * 24;

    ssd1306_DrawBitmap(2, selectorY, menu_selection_bitmap, 128, 21, 1);

    ssd1306_DrawBitmap(8, 57, click_bitmap, 16, 16, 1);
    ssd1306_DrawBitmap(8, 81, move_bitmap, 16, 16, 1);
    ssd1306_DrawBitmap(8, 105, cogwheel_bitmap, 16, 16, 1);

    ssd1306_SetCursor(40, 61);
    ssd1306_WriteString("CLICK MODE", Font_6x8, White);

    ssd1306_SetCursor(43, 85);
    ssd1306_WriteString("MOVE MODE", Font_6x8, White);

    ssd1306_SetCursor(40, 109);
    ssd1306_WriteString("PARAMETERS", Font_6x8, White);
}

void drawParamsMenu(const uint8_t index) {
    ssd1306_Fill(Black);

    const uint8_t selectorY = 30 + index * 24;

    ssd1306_DrawBitmap(2, selectorY, menu_selection_bitmap, 128, 21, 1);

    ssd1306_SetCursor(52, 5);
    char value_buf[6];
    if (index == 0) {
        snprintf(value_buf, sizeof(value_buf), "%d", num_cycles);
        ssd1306_WriteString(value_buf, Font_11x18, White);
    } else if (index == 1) {
        snprintf(value_buf, sizeof(value_buf), "%d", sensor_threshold);
        ssd1306_WriteString(value_buf, Font_11x18, White);
    }


    ssd1306_DrawBitmap(25, 6, left_bitmap, 8, 15, 1);
    ssd1306_DrawBitmap(91, 5, right_bitmap, 8, 15, 1);


    ssd1306_DrawBitmap(8, 32, cycles_bitmap, 16, 16, 1);
    ssd1306_DrawBitmap(8, 56, threshold_bitmap, 24, 13, 1);
    ssd1306_DrawBitmap(8, 80, exit_bitmap, 15, 14, 1);

    ssd1306_SetCursor(40, 36);
    ssd1306_WriteString("  CYCLES  ", Font_6x8, White);

    ssd1306_SetCursor(43, 60);
    ssd1306_WriteString("THRESHOLD", Font_6x8, White);

    ssd1306_SetCursor(37, 84);
    ssd1306_WriteString("SAVE & EXIT", Font_6x8, White);

    drawSensorBarInline();

    ssd1306_UpdateScreen();
}

void drawMeasurement(const uint32_t baseline, const uint32_t new,
    const uint32_t latency) {
    ssd1306_Fill(Black);

    ssd1306_Line(0, 36, 127, 36, 1);

    ssd1306_SetCursor(1, 1);
    ssd1306_WriteString("CYCLE", Font_6x8, White);

    ssd1306_SetCursor(35, 12);
    char cycle_buf[12];
    snprintf(cycle_buf, sizeof(cycle_buf), "%d / %d", cycle_index + 1, num_cycles);
    ssd1306_WriteString(cycle_buf, Font_11x18, White);

    ssd1306_Line(0, 72, 127, 72, 1);

    ssd1306_SetCursor(1, 37);

    ssd1306_WriteString("BRIGHTNESS", Font_6x8, White);

    ssd1306_SetCursor(3, 48);
    char baseline_buf[5];
    snprintf(baseline_buf, sizeof(baseline_buf), "%lu", baseline);
    ssd1306_WriteString(baseline_buf, Font_11x18, White);

    if (new != -1) {
        ssd1306_SetCursor(78, 48);
        char new_buf[11];
        snprintf(new_buf, sizeof(new_buf), "%lu", new);
        ssd1306_WriteString(new_buf, Font_11x18, White);

        ssd1306_DrawBitmap(55, 54, arrow_bitmap, 17, 10, 1);
    }

    ssd1306_SetCursor(1, 74);
    ssd1306_WriteString("LATENCY", Font_6x8, White);

    if (latency != -1) {
        ssd1306_SetCursor(93, 89);
        ssd1306_WriteString("ms", Font_11x18, White);

        ssd1306_SetCursor(2, 89);
        char latency_buf[14];
        snprintf(latency_buf, sizeof(latency_buf), "%.3f", latency / 1000.0f);
        ssd1306_WriteString(latency_buf, Font_11x18, White);
    }


    ssd1306_UpdateScreen();

}

uint32_t getMin(uint32_t latencies_us[]) {
    uint32_t min = latencies_us[0] / 1000;
    for (uint8_t i = 1; i < num_cycles; i++) {
        if (latencies_us[i] / 1000 < min) {
            min = latencies_us[i] / 1000;
        }
    }
    return min;
}

uint32_t getMax(uint32_t latencies_us[]) {
    uint32_t max = latencies_us[0] / 1000;
    for (uint8_t i = 1; i < num_cycles; i++) {
        if (latencies_us[i] / 1000 > max) {
            max = latencies_us[i] / 1000;
        }
    }
    return max;
}

void drawGraphInline(uint32_t latencies_us[]) {
    ssd1306_Line(4, 60, 4, 96, 1);
    ssd1306_Line(2, 94, 122, 94, 1);
    ssd1306_Line(4, 60, 5, 61, 1);
    ssd1306_Line(122, 94, 121, 95, 1);
    ssd1306_Line(4, 60, 3, 61, 1);
    ssd1306_Line(122, 94, 121, 93, 1);

    const uint32_t min = getMin(latencies_us);
    const uint32_t max = getMax(latencies_us);

    const uint32_t range = max - min;
    const float PIXEL_PER_VALUE = 30 / (float)range;
    const float PIXEL_PER_CYCLE = 120 / (float)num_cycles;
    for (int i = 0; i < num_cycles; i++) {
        ssd1306_DrawPixel((i+1)*PIXEL_PER_CYCLE, 93 - (int)(latencies_us[i] / 1000 - min) * PIXEL_PER_VALUE, White);
    }
}

void drawAverage(uint32_t latencies_us[], const float mean_ms, const float sd_ms) {
    ssd1306_Fill(Black);

    ssd1306_SetCursor(2, 2);
    ssd1306_WriteString("MEAN", Font_6x8, White);

    ssd1306_SetCursor(2, 30);
    ssd1306_WriteString("STANDARD DEVIATION", Font_6x8, White);

    ssd1306_SetCursor(107, 16);
    ssd1306_WriteString("ms", Font_6x8, White);

    ssd1306_SetCursor(107, 46);
    ssd1306_WriteString("ms", Font_6x8, White);

    ssd1306_SetCursor(2, 10);
    char mean_buf[14];
    snprintf(mean_buf, sizeof(mean_buf), "%.3f", mean_ms);
    ssd1306_WriteString(mean_buf, Font_11x18, White);

    ssd1306_SetCursor(2, 38);
    char sd_buf[14];
    snprintf(sd_buf, sizeof(sd_buf), "%.3f", sd_ms);
    ssd1306_WriteString(sd_buf, Font_11x18, White);

    ssd1306_DrawBitmap(1, 105, menu_selection_bitmap, 128, 21, 1);
    ssd1306_DrawBitmap(8, 108, exit_bitmap, 15, 14, 1);
    ssd1306_SetCursor(41, 112);
    ssd1306_WriteString("MAIN MENU", Font_6x8, White);
    
    drawGraphInline(latencies_us);

    ssd1306_UpdateScreen();
}

void drawError(char *error) {
    ssd1306_Fill(Black);
    ssd1306_SetCursor(10, 50);
    ssd1306_WriteString(error, Font_11x18, White);
    ssd1306_UpdateScreen();
}